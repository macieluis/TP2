<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Ground Control - TP2</title>
    <style>
        body { background: #1e1e1e; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; padding: 20px; display: flex; gap: 20px; height: 95vh; box-sizing: border-box; }
        
        /* COLUNA ESQUERDA: CONFIGURADOR */
        .mission-builder { flex: 0 0 400px; background: #2d2d2d; padding: 20px; border-radius: 8px; border: 1px solid #444; display: flex; flex-direction: column; overflow-y: auto; }
        .mission-builder h2 { color: #4CAF50; border-bottom: 1px solid #555; padding-bottom: 10px; margin-top: 0; font-size: 1.4em; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: bold; font-size: 0.9em; color: #fff; margin-bottom: 6px; }
        .form-group small { display: block; font-size: 0.8em; color: #aaa; margin-bottom: 6px; line-height: 1.3; }
        
        select, input { width: 100%; background: #222; border: 1px solid #555; color: #fff; padding: 10px; border-radius: 4px; font-size: 0.95em; box-sizing: border-box; }
        select:focus, input:focus { border-color: #4CAF50; outline: none; }

        /* Caixa de Ajuda */
        #mission-help { background: #222; border-left: 3px solid #2196F3; padding: 10px; margin-bottom: 15px; font-size: 0.85em; color: #ccc; }
        
        .hidden { display: none; }
        
        #btn-send { width: 100%; padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: auto; font-size: 1.1em; transition: background 0.2s; }
        #btn-send:hover { background: #45a049; }

        /* COLUNA DIREITA: MONITORES */
        .monitor-panel { flex: 1; display: flex; flex-direction: column; }
        .monitor-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #4CAF50; padding-bottom: 10px; margin-bottom: 20px; }
        .monitor-header h1 { margin: 0; color: #4CAF50; font-size: 1.8em; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; overflow-y: auto; }
        
        /* Cart√£o Rover */
        .card { background: #2c2c2c; border: 1px solid #444; padding: 20px; border-radius: 8px; position: relative; transition: transform 0.2s; }
        .card:hover { border-color: #666; }
        
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .card h2 { margin: 0; font-size: 1.4em; display: flex; align-items: center; }
        
        .status-badge { font-size: 0.7em; padding: 3px 8px; border-radius: 12px; font-weight: bold; text-transform: uppercase; }
        
        .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 10px; }
        .online { background: #4CAF50; box-shadow: 0 0 8px #4CAF50; color: #4CAF50; border: 1px solid #4CAF50; }
        .offline { background: #F44336; color: #F44336; border: 1px solid #F44336; }
        .charging { background: #FFC107; box-shadow: 0 0 8px #FFC107; color: #FFC107; border: 1px solid #FFC107; }

        .info-row { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid #3a3a3a; padding-bottom: 4px; font-size: 0.95em; }
        .label { color: #aaa; }
        .val { font-weight: bold; color: #fff; }

        .progress-bg { background: #444; height: 8px; border-radius: 4px; margin-top: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: #2196F3; transition: width 0.5s ease; }
        
        #loading { color: #888; font-style: italic; text-align: center; margin-top: 50px; }

        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: #333; color: #fff; padding: 15px 20px; border-radius: 5px; border-left: 5px solid #4CAF50; box-shadow: 0 5px 15px rgba(0,0,0,0.5); min-width: 250px; animation: slideIn 0.3s ease-out; }
        .toast.aborted { border-left-color: #F44336; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .history-panel { margin-top: 20px; background: #252525; padding: 15px; border-radius: 8px; border: 1px solid #333; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; color: #888; font-size: 0.9em; padding-bottom: 8px; border-bottom: 1px solid #444; }
        td { padding: 8px 0; color: #ddd; font-size: 0.95em; border-bottom: 1px solid #333; }
        .st-completed { color: #4CAF50; }
        .st-aborted { color: #F44336; }
    </style>
</head>
<body>

    <div class="mission-builder">
        <h2>üõ†Ô∏è Configurar Miss√£o</h2>
        
        <div class="form-group">
            <label>1. Rover Alvo</label>
            <small>Para quem √© esta ordem?</small>
            <select id="sel-rover">
                <option value="">A aguardar conex√£o com Nave-M√£e...</option>
            </select>
        </div>

        <div class="form-group">
            <label>2. Tipo de Miss√£o</label>
            <select id="sel-task" onchange="updateForm()">
                <option value="scan_area">üì° Scan Area (Mapeamento)</option>
                <option value="collect_sample">ü™® Collect Sample (Recolha)</option>
                <option value="analyze_environment">üå°Ô∏è Analyze Environment (Sensores)</option>
            </select>
        </div>

        <div id="mission-help">
            O rover percorre uma √°rea em zig-zag para mapeamento.
        </div>

        <hr style="border-color: #444; margin: 15px 0;">

        <div id="opts-scan">
            <div class="form-group">
                <label>√Årea a Varrer (Coordenadas)</label>
                <small>Zona geogr√°fica exata onde o rover vai operar.</small>
                <select id="sel-area">
                    <option value="[[0,0],[10,10]]">√Årea Padr√£o [0,0] at√© [10,10] (100m¬≤)</option>
                    <option value="[[0,0],[20,20]]">√Årea Grande [0,0] at√© [20,20] (400m¬≤)</option>
                    <option value="[[5,5],[15,15]]">√Årea Deslocada [5,5] at√© [15,15]</option>
                </select>
            </div>
            <div class="form-group">
                <label>Resolu√ß√£o (Detalhe)</label>
                <small>Espa√ßamento entre as linhas de varrimento.</small>
                <select id="sel-resolution">
                    <option value="1.0">1.0 metro (Normal)</option>
                    <option value="2.0">2.0 metros (R√°pido, menos detalhe)</option>
                    <option value="0.5">0.5 metros (Lento, muito detalhe)</option>
                </select>
            </div>
        </div>

        <div id="opts-collect" class="hidden">
            <div class="form-group">
                <label>Rota de Recolha</label>
                <small>Sequ√™ncia exata de pontos GPS a visitar.</small>
                <select id="sel-points">
                    <option value="[[2,2],[8,8],[5,5]]">Tri√¢ngulo: (2,2) ‚Üí (8,8) ‚Üí (5,5)</option>
                    <option value="[[0,0],[0,10],[10,10],[10,0]]">Per√≠metro: 4 cantos da √Årea Padr√£o</option>
                    <option value="[[5,5]]">Ponto √önico: Centro (5,5)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Tipo de Amostra</label>
                <select id="sel-sample">
                    <option value="rock">ü™® Rochas (Geologia)</option>
                    <option value="dust">üå´Ô∏è Poeira (Atmosfera)</option>
                    <option value="ice">‚ùÑÔ∏è Gelo (Hidrologia)</option>
                </select>
            </div>
        </div>

        <div id="opts-analyze" class="hidden">
            <div class="form-group">
                <label>Sensores a Ativar</label>
                <small>O rover move-se aleatoriamente enquanto l√™ estes dados.</small>
                <div style="background: #222; padding: 10px; border: 1px solid #555; border-radius: 4px;">
                    <label style="font-weight: normal;"><input type="checkbox" id="chk-temp" checked> Temperatura (¬∞C)</label>
                    <label style="font-weight: normal;"><input type="checkbox" id="chk-rad" checked> Radia√ß√£o (mSv)</label>
                    <label style="font-weight: normal;"><input type="checkbox" id="chk-dust"> Densidade de P√≥ (%)</label>
                </div>
            </div>
        </div>

        <hr style="border-color: #444; margin: 15px 0;">

        <div class="form-group">
            <label>Dura√ß√£o M√°xima (Timeout)</label>
            <small>Tempo limite para completar a tarefa.</small>
            <select id="sel-duration">
                <option value="60">60 segundos (1 min)</option>
                <option value="120">120 segundos (2 min)</option>
                <option value="180">180 segundos (3 min)</option>
                <option value="300">300 segundos (5 min)</option>
            </select>
        </div>

        <div class="form-group">
            <label>Frequ√™ncia de Reporte</label>
            <small>Intervalo de envio de progresso √† Nave-M√£e.</small>
            <select id="sel-interval">
                <option value="5">A cada 5 segundos (Detalhado)</option>
                <option value="10">A cada 10 segundos (Normal)</option>
                <option value="15">A cada 15 segundos (Econ√≥mico)</option>
                <option value="20">A cada 20 segundos</option>
            </select>
        </div>

        <button id="btn-send" onclick="sendMission()">üöÄ Enviar Miss√£o</button>
    </div>

    <div class="monitor-panel">
        <div class="monitor-header">
            <h1>üõ∞Ô∏è Monitoriza√ß√£o da Frota</h1>
            <div style="font-size: 0.9em; color: #aaa;" id="last-update">Aguardando dados...</div>
        </div>
        
        <div id="app" class="grid"></div>

        <div class="history-panel">
            <h3 style="margin:0; color:#2196F3">üìú Hist√≥rico de Miss√µes (√öltimas 10)</h3>
            <table>
                <thead>
                    <tr>
                        <th>Hora</th>
                        <th>Rover</th>
                        <th>Miss√£o ID</th>
                        <th>Estado Final</th>
                    </tr>
                </thead>
                <tbody id="history-body">
                    </tbody>
            </table>
        </div>

        <div id="loading">A tentar ligar √† API da Nave-M√£e (127.0.0.1:8000)...</div>
    </div>

    <div id="toast-container"></div>

    <script>
        const API = "http://127.0.0.1:8000";
        let knownRovers = new Set();
        let globalState = {}; // Armazena o estado para valida√ß√£o
        let lastEvents = {};

        // ATUALIZA A CAIXA DE AJUDA E OS CAMPOS VIS√çVEIS
        function updateForm() {
            const task = document.getElementById('sel-task').value;
            const helpBox = document.getElementById('mission-help');
            
            // Esconder tudo primeiro
            document.getElementById('opts-scan').classList.add('hidden');
            document.getElementById('opts-collect').classList.add('hidden');
            document.getElementById('opts-analyze').classList.add('hidden');

            if (task === 'scan_area') {
                document.getElementById('opts-scan').classList.remove('hidden');
                helpBox.innerHTML = "üì° <b>Scan Area:</b> O rover cobre a √°rea selecionada em linhas paralelas (zig-zag) para mapeamento completo.";
            } 
            else if (task === 'collect_sample') {
                document.getElementById('opts-collect').classList.remove('hidden');
                helpBox.innerHTML = "ü™® <b>Collect Sample:</b> O rover viaja sequencialmente pelos pontos da rota escolhida e para em cada um para recolher amostras.";
            } 
            else if (task === 'analyze_environment') {
                document.getElementById('opts-analyze').classList.remove('hidden');
                helpBox.innerHTML = "üå°Ô∏è <b>Analyze Env:</b> O rover vagueia aleatoriamente na zona, registando dados dos sensores escolhidos at√© o tempo acabar.";
            }
        }

        // ENVIA A MISS√ÉO PARA A API (COM VERIFICA√á√ÉO DE ESTADO)
        async function sendMission() {
            const rid = document.getElementById('sel-rover').value;
            if (!rid) { alert("‚ö†Ô∏è Erro: Nenhum rover selecionado."); return; }

            // 1. VERIFICA√á√ÉO INTELIGENTE DE ESTADO
            const roverInfo = globalState[rid];
            if (!roverInfo) return alert("Dados do rover indispon√≠veis.");

            if (roverInfo.status === 'offline') {
                return alert(`‚ùå ERRO: O ${rid} est√° OFFLINE. Inicie o cliente rover primeiro.`);
            }

            let confirmMsg = `Confirmar envio de miss√£o para o ${rid}?`;
            let isQueued = false;

            // Se estiver ocupado
            if (roverInfo.status === 'in_mission' || roverInfo.status === 'moving' || roverInfo.status === 'collecting' || roverInfo.status === 'scanning') {
                confirmMsg = `‚ö†Ô∏è AVISO: O ${rid} j√° est√° em miss√£o (${roverInfo.status.toUpperCase()}).\n\nDeseja colocar esta nova miss√£o na FILA DE ESPERA?`;
                isQueued = true;
            } 
            // Se estiver a carregar
            else if (roverInfo.status === 'charging') {
                confirmMsg = `‚ö†Ô∏è AVISO: O ${rid} est√° a CARREGAR bateria.\n\nDeseja AGENDAR a miss√£o para quando terminar?`;
                isQueued = true;
            }

            if(!confirm(confirmMsg)) return;

            const task = document.getElementById('sel-task').value;
            
            // 2. CONSTRUIR PAYLOAD
            const payload = {
                rover_id: rid,
                task: task,
                duration: parseInt(document.getElementById('sel-duration').value),
                update_interval: parseInt(document.getElementById('sel-interval').value)
            };

            if (task === 'scan_area') {
                payload.area = JSON.parse(document.getElementById('sel-area').value);
                payload.resolution = parseFloat(document.getElementById('sel-resolution').value);
            } else if (task === 'collect_sample') {
                payload.points = JSON.parse(document.getElementById('sel-points').value);
                payload.sample_type = document.getElementById('sel-sample').value;
            } else if (task === 'analyze_environment') {
                payload.area = [[0,0],[10,10]]; 
                const s = [];
                if(document.getElementById('chk-temp').checked) s.push('temperature');
                if(document.getElementById('chk-rad').checked) s.push('radiation');
                if(document.getElementById('chk-dust').checked) s.push('dust_level');
                payload.sensors = s;
            }

            // 3. ENVIAR
            try {
                const res = await fetch(`${API}/api/missions`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const json = await res.json();
                if(res.ok) {
                    if(isQueued) alert("‚úÖ Sucesso: Miss√£o adicionada √† fila de espera.");
                    else alert("‚úÖ Sucesso: Miss√£o enviada!");
                }
                else alert("‚ùå Erro na API: " + json.error);
            } catch(e) { alert("Erro de liga√ß√£o √† Nave-M√£e: " + e); }
        }

        // POLLING DE ESTADO
        async function update() {
            try {
                const res = await fetch(`${API}/api/state`);
                if(!res.ok) throw new Error("API Error");
                const data = await res.json();
                globalState = data; // Guardar estado para valida√ß√£o
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('last-update').innerText = "Sync: " + new Date().toLocaleTimeString();
                
                // Atualizar Dropdown de Rovers
                const roverSelect = document.getElementById('sel-rover');
                const currentSelection = roverSelect.value;
                
                for(const rid of Object.keys(data)) {
                    if(!knownRovers.has(rid)) {
                        knownRovers.add(rid);
                        const opt = document.createElement('option');
                        opt.value = rid;
                        opt.innerText = rid;
                        roverSelect.appendChild(opt);
                    }
                }
                if (currentSelection === "" && roverSelect.options.length > 1) {
                    roverSelect.selectedIndex = 1;
                }

                // Desenhar Cart√µes
                const container = document.getElementById('app');
                container.innerHTML = '';

                if(Object.keys(data).length === 0) {
                    container.innerHTML = '<p style="color:#666; margin-left:10px">Nenhum rover detetado.</p>';
                    return;
                }

                for(const [rid, info] of Object.entries(data)) {
                    const status = info.status || 'offline';
                    const isOffline = (status === 'offline');
                    
                    let statusColor = '#F44336'; // Offline red
                    let statusText = 'OFFLINE';
                    let borderColor = '#444';

                    if (info.last_finished) {
                        const lastTs = lastEvents[rid] || 0;
                        // Se o evento √© novo (timestamp maior que o √∫ltimo visto)
                        if (info.last_finished.ts > lastTs) {
                            lastEvents[rid] = info.last_finished.ts;
                            showToast(rid, info.last_finished.id, info.last_finished.status);
                        }
                    }
                    
                    if (status === 'in_mission' || status === 'moving' || status === 'collecting' || status === 'scanning' || status === 'analyzing') { 
                        statusColor = '#2196F3'; statusText = 'EM MISS√ÉO'; borderColor = '#2196F3'; 
                    } else if (status === 'charging') { 
                        statusColor = '#FFC107'; statusText = 'A CARREGAR'; borderColor = '#FFC107'; 
                    } else if (status === 'idle') { 
                        statusColor = '#4CAF50'; statusText = 'AGUARDANDO'; borderColor = '#4CAF50'; 
                    }

                    const batt = info.battery !== undefined ? info.battery.toFixed(1) + '%' : '---';
                    const pos = info.position ? `[${info.position[0].toFixed(1)}, ${info.position[1].toFixed(1)}]` : '---';
                    const mission = info.mission_id || '---';
                    const progress = info.mission_progress !== undefined ? info.mission_progress.toFixed(0) + '%' : '0%';

                    const html = `
                        <div class="card" style="border-left: 4px solid ${isOffline ? '#444' : borderColor}; opacity: ${isOffline ? 0.6 : 1}">
                            <div class="card-header">
                                <h2>${rid}</h2>
                                <span class="status-badge" style="border: 1px solid ${statusColor}; color: ${statusColor}">${statusText}</span>
                            </div>
                            
                            <div class="info-row"><span class="label">Bateria</span> <span class="val" style="color:${info.battery < 20 ? '#FF5252' : '#fff'}">${batt}</span></div>
                            <div class="info-row"><span class="label">Posi√ß√£o (X, Y)</span> <span class="val">${pos}</span></div>
                            <div class="info-row"><span class="label">Miss√£o Atual</span> <span class="val">${mission}</span></div>
                            
                            <div class="progress-bg">
                                <div class="progress-fill" style="width:${progress}; background-color: ${statusColor}"></div>
                            </div>
                            <div style="text-align: right; font-size: 0.8em; color: #aaa; margin-top: 4px;">Progresso: ${progress}</div>
                        </div>
                    `;
                    container.innerHTML += html;
                }

            } catch(e) { 
                document.getElementById('loading').style.display = 'block';
            }
        }


        function showToast(rid, mid, status) {
            const container = document.getElementById('toast-container');
            const div = document.createElement('div');
            div.className = `toast ${status}`;
            div.innerHTML = `
                <div style="font-weight:bold; font-size:1.1em; margin-bottom:5px">${rid}</div>
                <div>Miss√£o ${mid} terminada.</div>
                <div style="font-size:0.8em; color:#aaa; margin-top:5px">STATUS: ${status.toUpperCase()}</div>
            `;
            container.appendChild(div);
            
            // Desaparecer ap√≥s 5 segundos
            setTimeout(() => {
                div.style.opacity = '0';
                div.style.transform = 'translateX(100%)';
                div.style.transition = 'all 0.5s';
                setTimeout(() => div.remove(), 500);
            }, 5000);
        }

        async function updateHistory() {
            try {
                const res = await fetch(`${API}/api/history`);
                const data = await res.json();
                
                const tbody = document.getElementById('history-body');
                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#666; padding:10px">Sem hist√≥rico recente.</td></tr>';
                    return;
                }

                data.forEach(row => {
                    let color = '#fff';
                    if(row.status === 'completed') color = '#4CAF50'; // Verde
                    if(row.status === 'aborted') color = '#F44336';   // Vermelho
                    
                    const html = `
                        <tr>
                            <td>${row.time}</td>
                            <td style="font-weight:bold">${row.rover_id}</td>
                            <td>${row.mission_id}</td>
                            <td style="color:${color}; text-transform:uppercase; font-size:0.8em; font-weight:bold">${row.status}</td>
                        </tr>
                    `;
                    tbody.innerHTML += html;
                });
            } catch(e) { console.log("Erro hist√≥rico"); }
        }

        // Inicializa√ß√£o
        updateForm();
        setInterval(() => {
            update();
            updateHistory(); 
        }, 1000);
        
        update();
        updateHistory();
        
    </script>
</body>
</html>