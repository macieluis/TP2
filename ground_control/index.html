<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Ground Control TP2</title>
    <style>
        body { background: #1e1e1e; color: #f0f0f0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; margin: 0; }
        h1 { border-bottom: 2px solid #4CAF50; padding-bottom: 10px; color: #4CAF50; }
        
        /* Grid Layout */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin-top: 20px; }
        
        /* Cart√£o do Rover */
        .card { background: #2d2d2d; border: 1px solid #444; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); border-color: #666; }
        
        /* Cabe√ßalho do Cart√£o */
        .card h2 { margin-top: 0; display: flex; align-items: center; font-size: 1.5em; }
        
        /* Indicador de Estado (Bolinha) */
        .status-dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; }
        .online { background: #4CAF50; box-shadow: 0 0 8px #4CAF50; } 
        .offline { background: #F44336; }
        .charging { background: #FFC107; box-shadow: 0 0 8px #FFC107; }

        /* Dados */
        .info-row { display: flex; justify-content: space-between; margin: 8px 0; border-bottom: 1px solid #3a3a3a; padding-bottom: 4px; }
        .label { color: #aaa; font-size: 0.9em; }
        .val { font-weight: bold; }

        /* √Årea de Bot√µes */
        .actions { margin-top: 20px; padding-top: 15px; border-top: 1px solid #555; }
        .actions p { margin: 0 0 10px 0; font-size: 0.85em; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        
        .btn-group { display: flex; gap: 8px; }
        
        button { flex: 1; padding: 10px 5px; cursor: pointer; background: #3a3a3a; color: #fff; border: 1px solid #555; border-radius: 5px; font-size: 0.9em; transition: all 0.2s; }
        button:hover { background: #4CAF50; border-color: #4CAF50; color: #fff; }
        button:active { transform: scale(0.98); }

        #loading { color: #888; font-style: italic; }
    </style>
</head>
<body>
    <h1>üõ∞Ô∏è Ground Control</h1>
    <div id="loading">A conectar √† Nave-M√£e...</div>
    <div id="app" class="grid"></div>

    <script>
        // ATEN√á√ÉO: Se mudares para o CORE, troca 127.0.0.1 pelo IP da Nave-M√£e
        const API = "http://127.0.0.1:8000";

        // Fun√ß√£o para enviar miss√£o (POST)
        async function sendMission(rid, task) {
            if(!confirm(`Confirmar miss√£o '${task}' para o ${rid}?`)) return;
            
            try {
                const res = await fetch(`${API}/api/missions`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ rover_id: rid, task: task })
                });
                const json = await res.json();
                
                if(res.ok) alert("‚úÖ Sucesso: " + json.msg);
                else alert("‚ùå Erro: " + json.error);

            } catch(e) { 
                alert("Erro de liga√ß√£o: " + e); 
            }
        }

        // Fun√ß√£o de atualiza√ß√£o peri√≥dica (Polling)
        async function update() {
            try {
                const res = await fetch(`${API}/api/state`);
                if(!res.ok) throw new Error("API Error");
                
                const data = await res.json();
                const container = document.getElementById('app');
                const loading = document.getElementById('loading');
                
                loading.style.display = 'none';
                container.innerHTML = ''; // Limpar para redesenhar

                if(Object.keys(data).length === 0) {
                    loading.style.display = 'block';
                    loading.innerText = 'Nave-M√£e online. √Ä espera de Rovers...';
                    return;
                }

                // Gerar cart√£o para cada Rover
                for(const [rid, info] of Object.entries(data)) {
                    const status = info.status || 'offline';
                    
                    // Determinar cor do status
                    let statusClass = 'offline';
                    if (status === 'charging') statusClass = 'charging';
                    else if (status !== 'offline') statusClass = 'online';

                    const isOffline = (status === 'offline');

                    // Formatar dados
                    const batt = info.battery !== undefined ? info.battery.toFixed(1) + '%' : '---';
                    const pos = info.position ? `[${info.position[0].toFixed(1)}, ${info.position[1].toFixed(1)}]` : '---';
                    const mission = info.mission_id || '---';
                    const progress = info.mission_progress !== undefined ? info.mission_progress.toFixed(0) + '%' : '';

                    // HTML do Cart√£o
                    const html = `
                        <div class="card" style="opacity: ${isOffline ? 0.6 : 1}">
                            <h2><span class="status-dot ${statusClass}"></span>${rid}</h2>
                            
                            <div class="info-row"><span class="label">ESTADO</span> <span class="val">${status.toUpperCase()}</span></div>
                            <div class="info-row"><span class="label">BATERIA</span> <span class="val">${batt}</span></div>
                            <div class="info-row"><span class="label">POSI√á√ÉO</span> <span class="val">${pos}</span></div>
                            <div class="info-row"><span class="label">MISS√ÉO</span> <span class="val">${mission} <small>${progress}</small></span></div>
                            
                            <div class="actions">
                                <p>Atribuir Miss√£o:</p>
                                <div class="btn-group">
                                    <button onclick="sendMission('${rid}', 'scan_area')">Scan</button>
                                    <button onclick="sendMission('${rid}', 'collect_sample')">Collect</button>
                                    <button onclick="sendMission('${rid}', 'analyze_environment')">Analyze</button>
                                </div>
                            </div>
                        </div>
                    `;
                    container.innerHTML += html;
                }
            } catch(e) { 
                document.getElementById('loading').innerText = '‚ö†Ô∏è Nave-M√£e offline ou inacess√≠vel...';
                document.getElementById('loading').style.display = 'block';
                document.getElementById('loading').style.color = '#F44336';
            }
        }

        // Iniciar loop de atualiza√ß√£o
        setInterval(update, 1000);
        update();
    </script>
</body>
</html>